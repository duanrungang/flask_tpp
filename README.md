# flask_tpp
# 项目分析

## 开发

- 淘票票
- 端
  - 淘票票后端
    - 淘票票公司自己管理
  - 客户端
    - 看电影用户准备的
  - 影院端
    - 电影放映

## 通用模块

- 用户体系
  - 用户权限
  - 用户角色
- 电影
  - 淘票票后端
    - 增删改查
  - 淘票票影院端
    - 查询
  - 淘票票客户端
    - 查询
- 影票
  - 淘票票后端
    - 增删改查
  - 影院端
    - 增删改查
  - 客户端
    - 增删查
- 排挡
  - 淘票票后端
    - 增删改查
  - 影院端
    - 增删改查
  - 客户端
    - 查

## 淘票票客户端

- 查看电影
- 查看影院
- 下单
  - 找到具体排挡
  - 选座（座位锁定），并发
    - 订单过期
  - 支付

## 淘票票影院端

- 后端购买来的电影播放权
  - 电影
- 放映厅
- 排挡
  - 关系表
  - 电影和放映厅+时间

## 淘票票后端

- 管理淘票票用户
- 淘票票影院管理
- 电影

## 拓展模块

- 优惠券
- 积分系统
- 影院会员系统
- 评价系统
- 定位（手机、浏览器）
- 地址
  - 后端规划好
  - 影院端添加

# 项目架构

## 第一种架构

- 一个项目入口
  - app/`__init__`
  - apis
    - admin
    - movie_admin
    - movie_user
  - models
    - admin
    - movie_admin
    - movie_user

## 第二种架构

- 另外一种架构
  - FlaskTpp
    - `__init__`
    - settings
    - ext
  - admin
    - apis
    - models
  - movie_admin
    - apis
    - models
  - Movie_user
    - apis
    - models

# 系统设计

## 关系

![1576157249317](/home/gang/Documents/notes/%E6%A1%86%E6%9E%B6/flask/1576157249317.png)

## 客户端

### 用户系统

- 字段
  - username
  - password
  - phone
  - email
  - is_delete
  - permission

### 权限设计

- 类似linux权限设计
  - 精髓，一个字段可以代表多种权限
  - 还能分为两种
    - 完全和linux一样
      - 使用二进制
      - 所有的初始权限值都是2的n次幂
    - 只是给一个数值
      - 数值越大权限越高
      - 数值小的所有权限
- 多表设计权限
  - 用户表
  - 权限表
  - 用户权限表
- 权限分类
  - 1   读权限
  - 2   写权限
  - 4   修改权限

### 权限设计升级

- 多表
  - 用户表
  - 权限表
  - 用户权限表
  - 权限组表
  - 权限组权限表
  - 用户权限组表
  - 用户组
  - 用户组表
  - 用户组权限表
  - 用户组权限组表

![1576760604363](/home/gang/Documents/notes/%E6%A1%86%E6%9E%B6/flask/1576760604363.png)

- 升级

![1576760826388](/home/gang/Documents/notes/%E6%A1%86%E6%9E%B6/flask/1576760826388.png)

- 升级



### 客户特殊登录

- 扫码登录
  - 前置条件
    - 有一个登录好的账号
  - 使用登录好账号中的token来访问自己登录接口
    - 常规登录接口
      - 用户名
      - 密码
      - 手机号
      - 邮箱
    - 特殊登录接口
      - 直接可以通过token进行登录
    - 扫码扫出来的就是特殊登录接口
- 跨应用登录
- 三方登录

## 多个接口拥有通用功能

- 如何复用代码
  - 装饰器
  - 钩子函数
  - 直接封装函数
  - 创建一个父类

## 城市导入脚本

- 获取城市信息
- 将城市信息读取出来
- 插入数据库中



## 影院端

- 用户
  - 一个用户对应多个电影院具体地址信息
- 用户购买的电影播放权
  - 
- 放映厅
- 排挡

### 排挡之后

- 用户可以查看排挡
- 下单（锁单）
- 支付

![1576724486925](/home/gang/Documents/notes/%E6%A1%86%E6%9E%B6/flask/1576724486925.png)

### 座位

- 所有座位应该是大厅的座位表
- 删除已经卖了的 座位
  - 已支付
  - 已取票
- 锁单
  - 已下单，未支付

### 并发

- 变并行为串行
- 加锁
  - 悲观锁
    - 对数据操作加锁
  - 乐观锁
    - 在读取的时候获取数据
    - 操作完成再读一遍，和预期一样

## 支付

- 如何确保支付
- 核心逻辑第三方平台不会暴露给后端服务器的
- 直接和支付平台对接的是客户端
- 客户端可以返回给服务器一个支付状态
  - 客户端并不可信
  - 还要有一个确保策略
  - 接收支付宝的回调
    - notify_url
      - 已付款待确认就是客户端告诉你成功，但是还没有收到支付宝的回调

## 票房排行

- 电影和钱来个排序
- 电影表
- 钱
  - 订单
- 电影
  - 排挡
- 订单
  - 排挡

# 项目流程

- 产品经理提出需求
- 开会，评审
- 要添加功能，周期（时间）
- 数据设计
  - DBA
  - 架构师
  - 后端经验丰富的工程
  - 自己设计
- 建库建表
  - 模型建立
- 对数据库进行操作
  - CRUD
  - 和前端进行联调
    - 前端需要请求接口
    - 接口对接
      - API文档
      - 接口功能
      - 接口地址
      - 接口所需参数
        - 哪些是必须的，哪些是非必须的，哪些是通用参数
      - 接口返回数据
        - 数据字段
        - 状态码
        - 错误码
- 设计操作权限
  - 登录才能操作
  - 权限级别
- 送测
  - 测试工程师会有bug反馈
- 修复bug
  - 送测
- 上线



# 项目目前状况

- 三端划分
  - 客户端
  - 商家端
  - 后端
- 客户端
  - 用户模块
    - 注册登录
    - 信息修改
    - 用户删除（不允许）
    - 权限
- 商家端
  - XXX
- 后端
  - XXX
- 通用模块
  - 地址管理

## 接下来

- 电影
  - 电影哪来的（后端）
- 后端
  - 用户实现（淘票票管理系统）
  - 可以实现电影的增删该查
- 客户端就可以实现电影查询
- 查询电影院（影院端）
  - 用户实现（影院端）
  - 获取电影列表
  - 购买电影播放权

## 电影

- 电影属于哪个公司
- 演员
- 操作
  - CRUD
    - C
      - 应该只有后台登录的管理员能创建
      - token认证
        - 会出现多个端token混乱
          - 不同token对应相同的id值
          - 解决方案
            - token 加前缀或后缀
              - movieuser
            - 修改表结构，user_id
              - 但值是字符串，里面存uuid

## 之后

- 电影院有排挡
- 用户浏览具体排挡下单
- 票房排行
  - 统计电影卖的所有的票的总和
  - 电影
    - 排挡
      - 订单
        - 价钱
- 热度排行



# 项目简单回顾

- 端
  - 用户端
  - 商家端
  - 后台管理端
- 用户模块
  - 用户权限
    - linux
    - 多表
- 电影
- 商家电影授权
  - 商家和电影
- 电影院的地址
  - 级联到商家
- 放映厅
  - 坐标系
  - 级联到电影院地址
- 排挡
  - 放映厅和电影
  - 电影已经买了的，授权了的
- 订单
  - 排挡和用户
  - 座位的筛选
    - 将买了的
    - 锁定的
  - 订单锁定
    - 懒处理方式
    - 通过一个过期时间搞定
  - 订单生成
    - 座位表获取
    - 座位表确认
    - 并发处理
      - 锁
        - 乐观锁
          - 操作前和操作后进行比对
          - 如果满足预期是成功
        - 悲观锁
          - 真的给库，给表加锁
            - 效率低
      - 事务
        - 默认ORM开启事务
        - begin
        - commit
        - rollback
          - 多个操作才有意义
    - 支付
      - 和django中一样
      - 支付注意配置支付账号的信息
      - 支付的时候调用指定客户端
        - web
        - phone
        - 区别是调用接口不一样，参数都一样
          - 使用的库封装了，对应的就是函数名不一样
      - 确保支付结果
        - 接收支付宝回调

# 拓展

## django扩容

- 执行原生SQL
  - object.raw(‘SQL’)
- 想做字段选择
  - defer
    - 不要哪些字段
  - only
    - 只要哪些字段





